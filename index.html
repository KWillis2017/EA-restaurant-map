<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EA Community Restaurant Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

  <style>
    html, body, #map { height: 100%; margin: 0; }
    .header {
      position: absolute; z-index: 999; left: 12px; top: 12px;
      background: rgba(255,255,255,0.92); padding: 10px 14px; border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .header h1 { font-size: 18px; margin: 0 0 6px 0; }
    .header p { font-size: 12px; margin: 0; color: #444; }
    .leaflet-popup-content { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .city { font-weight: 700; margin-bottom: 6px; }
    ul { padding-left: 18px; margin: 6px 0; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="header">
    <h1>EA Community Restaurant Map</h1>
    <p>Data source: Google Sheet (published as CSV). If direct load fails, this page retries via a CORS proxy.</p>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQxaGDGw9eUTPb7IfQvIo2QsU53BVzO1vIQxRQOLfLjkeKUyy6kpBubjqtCJa10TYC2R2pa4xpgQms4/pub?output=csv';
    const PROXY_PREFIX = "https://cors.isomorphic-git.org/";

    const map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const cluster = L.markerClusterGroup();
    map.addLayer(cluster);

    function renderRows(rows) {
      let anyMarker = false;
      rows.forEach(row => {
        const city = (row['City'] || '').trim();
        const latStr = (row['Latitude'] || '').trim();
        const lonStr = (row['Longitude'] || '').trim();
        const restaurantsRaw = (row['Restaurants'] || '').trim();
        if (!city || !latStr || !lonStr || !restaurantsRaw) return;
        const lat = parseFloat(latStr);
        const lon = parseFloat(lonStr);
        if (isNaN(lat) || isNaN(lon)) return;
        const items = restaurantsRaw.split(/;|\||â€¢/g).map(s => s.trim()).filter(Boolean);
        const list = items.map(r => `<li>${r}</li>`).join('');
        const marker = L.marker([lat, lon]).bindPopup(`<div class="city">${city}</div><ul>${list}</ul>`);
        cluster.addLayer(marker);
        anyMarker = true;
      });
      if (anyMarker) {
        try { map.fitBounds(cluster.getBounds(), { padding: [30, 30] }); } catch (e) {}
      } else {
        alert('No valid rows found. Make sure your sheet has headers: City, Latitude, Longitude, Restaurants');
      }
    }

    function loadViaPapa(url) {
      return new Promise((resolve, reject) => {
        Papa.parse(url, {
          download: true,
          header: true,
          skipEmptyLines: true,
          complete: (results) => resolve(results.data || []),
          error: (err) => reject(err)
        });
      });
    }

    async function init() {
      const csvURL = SHEET_CSV_URL + (SHEET_CSV_URL.includes('?') ? '&' : '?') + 'cacheBust=' + Date.now();
      try {
        const rows = await loadViaPapa(csvURL);
        renderRows(rows);
      } catch (e1) {
        console.warn('Direct CSV load failed, retrying via proxy...', e1);
        try {
          const proxied = PROXY_PREFIX + csvURL;
          const resp = await fetch(proxied);
          const text = await resp.text();
          const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
          renderRows(parsed.data || []);
        } catch (e2) {
          console.error('CSV load failed even via proxy:', e2);
          alert('Could not load the Google Sheet. If your Workspace blocks Publish-to-Web, share the sheet as "Anyone with the link: Viewer" and use the /export?format=csv&gid=... URL instead.');
        }
      }
    }

    init();
  </script>
</body>
</html>
